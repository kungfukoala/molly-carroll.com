/**
 * Location
 * for the Statamic Control Panel
 *
 * @author  Fred LeBlanc  <fred@statamic.com>
 * @copyright  2012
 */(function(e){"use strict";var t,n,r;t={starting_latitude:44.33,starting_longitude:-68.21,starting_zoom:15,allow_geolocation:!0,geolocation_zoom:17,use_foursquare:!1,foursquare_client_id:"",foursquare_client_secret:"",foursquare_radius:200,attribution:"",min_zoom:4,max_zoom:18,float_precision:4,common_locations:[],interaction:{scroll_wheel_zoom:!0,double_click_zoom:!0,box_zoom:!0,touch_zoom:!0,draggable:!0},cloudmade_api_key:"336304a90a064433aee8146c4d6668f5",cloudmade_tile_set_id:997,detect_retina:!0};n={map:{element:null,object:null},marker:{latitude:null,longitude:null,object:null},timeouts:{latitude:null,longitude:null},version_date:"20121226"};r={init:function(i){var s=e.extend({},t,i,n);return this.each(function(){var t=e(this);t.data("location",e.extend(!0,{},s));try{r.verify.apply(t);r.overrideConfiguration.apply(t);r.startMap.apply(t);r.createHelperLinks.apply(t);r.bindInputEvents.apply(t)}catch(n){alert("An error occurred trying to initialized the map.")}})},verify:function(){if(!e(this).is(".input-location"))throw"Cannot verify location input, not an .input-location element.";if(!e(this).children(".map").length)throw"Cannot verify location input, missing map.";e.isArray(e(this).data("location").common_locations)||(e(this).data("location").common_locations=[]);return!0},overrideConfiguration:function(){var t,n=e(this),r=n.data("location");t=n.find(".map").data("location-configuration");if(!t)return;n.data("location",e.extend({},r,t))},startMap:function(){var t,n=_.uniqueId("map-"),i=e(this),s=i.data("location");i.find(".latitude > input").val()!==""&&i.find(".longitude > input").val()!==""?t=[parseFloat(i.find(".latitude > input").val()),parseFloat(i.find(".longitude > input").val())]:t=[s.starting_latitude,s.starting_longitude];s.map.element=i.children(".map").attr("id",n);s.map.object=L.map(n,{scrollWheelZoom:s.interaction.scroll_wheel_zoom,doubleClickZoom:s.interaction.double_click_zoom,boxZoom:s.interaction.box_zoom,touchZoom:s.interaction.touch_zoom,dragging:s.interaction.draggable}).setView(t,s.starting_zoom);L.tileLayer("http://{s}.tile.cloudmade.com/{key}/{styleId}/256/{z}/{x}/{y}.png",{attribution:s.attribution,maxZoom:s.max_zoom,minZoom:s.min_zoom,key:s.cloudmade_api_key,styleId:s.cloudmade_tile_set_id,detectRetina:s.detect_retina}).addTo(s.map.object);r.bindMapEvents.apply(i);i.find(".latitude > input").val()&&i.find(".longitude > input").val()&&r.placeMarker.apply(i,[parseFloat(i.find(".latitude > input").val()),parseFloat(i.find(".longitude > input").val())])},createHelperLinks:function(){var t=e(this),n=t.data("location");if(t.find(".helpers").length)return;t.find(".entry").append('<div class="helpers"><section><label>Helpful Map Tools</label><ul></ul></section></div>');n.common_locations.length&&e("#location-selector").length&&t.find(".helpers ul").append('<li class="common-locations"><a href="#">Common Places</a></li>');t.find(".helpers ul").append('<li class="locate-address"><a href="#">Locate an Address</a></li>');n.allow_geolocation&&r.supportsGeolocation.apply(t)&&t.find(".helpers ul").append('<li class="use-my-location"><a href="#">Use My Location</a><span></span></li>');t.find(".helpers").append("<section><label>Reset</label><ul></ul></section>");t.find(".helpers ul").eq(1).append('<li class="remove-marker"><a href="#">Remove Marker</a></li>');n.marker.object||r.disableHelperLink.apply(t,["remove-marker"]);t.find(".helpers .common-locations a").on("click",function(){r.showCommonPlaces.apply(t);return!1}).end().find(".helpers .remove-marker a").on("click",function(){r.removeMarker.apply(t);return!1}).end().find(".helpers .locate-address a").on("click",function(){r.showAddressLookup.apply(t);return!1}).end().find(".helpers .use-my-location a").on("click",function(){r.findMe.apply(t);return!1})},bindInputEvents:function(){var t=e(this);t.find(".latitude > input, .longitude > input").on("keyup",function(){r.attemptPlaceMarker.apply(t,[])})},enableHelperLink:function(t){e(this).find("."+t+" a").removeClass("disabled")},disableHelperLink:function(t){e(this).find("."+t+" a").addClass("disabled")},supportsGeolocation:function(){return"geolocation"in navigator},fillForm:function(t){var n=t.zoom||null,i=e(this);t.name&&i.find(".name input").val(t.name);t.latitude&&i.find(".latitude > input").val(t.latitude);t.longitude&&i.find(".longitude > input").val(t.longitude);r.attemptPlaceMarker.apply(i,[n])},standardizeCoordinate:function(e){return _.isNumber(e)&&!isNaN(e)?e:_.isString(e)?parseFloat(e):0},findMe:function(){var t=e(this),n=t.data("location"),i=t.find(".use-my-location span");if(!r.supportsGeolocation.apply(t))return!1;i.spin();navigator.geolocation.getCurrentPosition(function(e){var s=e.coords.latitude.toFixed(n.float_precision),o=e.coords.longitude.toFixed(n.float_precision);try{r.getNearestFoursquareVenue.apply(t,[s,o])}catch(u){r.placeMarker.apply(t,[s,o,!0,n.geolocation_zoom])}i.spin(!1)},function(e){switch(e.code){case 1:alert("We can’t find you, you wouldn’t let us.");break;case 2:alert("We can’t find you, the network isn’t available.");break;case 3:alert("We can’t find you, the network is taking too long.")}})},getNearestFoursquareVenue:function(t,n){var i=e(this),s=i.data("location");if(!s.foursquare_client_id||!s.foursquare_client_secret)throw"Missing Foursquare credentials.";e.getJSON("https://api.foursquare.com/v2/venues/search",{ll:t+","+n,client_id:s.foursquare_client_id,client_secret:s.foursquare_client_secret,radius:s.foursquare_radius,v:s.version_date},function(e){e.meta.code===200&&e.response.venues.length&&e.response.venues[0].name&&i.find(".name input").val(e.response.venues[0].name);r.placeMarker.apply(i,[t,n,!0,s.geolocation_zoom])})},showCommonPlaces:function(){var t=e(this),n=t.data("location");e("#modal-placement").length||e("#wrap").after('<div id="modal-placement"></div>');e("#location-modal .modal-body ul li").length||e.each(n.common_locations,function(){e("#location-modal .modal-body ul").append('<li><a href="#" data-name="'+this.name+'" data-latitude="'+this.latitude+'" data-longitude="'+this.longitude+'" data-zoom="'+this.zoom+'">'+this.name+"</a></li>")});e("#modal-placement").unbind(".location").on("click.location",".modal-body ul a",function(){r.fillForm.apply(t,[{name:e(this).data("name"),latitude:e(this).data("latitude"),longitude:e(this).data("longitude"),zoom:e(this).data("zoom")}]);e("#location-modal").modal("hide");return!1}).html(e("#location-selector").html());e("#location-modal").modal()},showAddressLookup:function(){var t=e(this),n=t.data("location");e("#modal-placement").length||e("#wrap").after('<div id="modal-placement"></div>');e("#modal-placement").unbind(".location").on("submit.location","form",function(){var i=e(this).find("input#modal-address-field").val();e.getJSON("http://open.mapquestapi.com/geocoding/v1/address?callback=?",{location:i,maxResults:1,thumbMaps:!1},function(i){if(i.results.length&&i.results[0].locations.length){r.fillForm.apply(t,[{name:i.results[0].providedLocation.location,latitude:i.results[0].locations[0].latLng.lat.toFixed(n.float_precision),longitude:i.results[0].locations[0].latLng.lng.toFixed(n.float_precision)}]);e("#address-modal").modal("hide")}else e("#modal-placement form small").animate({opacity:0},150,function(){e(this).css("color","#BF1D2D").text("Sorry, we could not find that address.").animate({opacity:1},150)})});return!1}).html(e("#address-lookup").html());e("#address-modal").modal()},attemptPlaceMarker:function(){var t,n,i=arguments[0]||null,s=e(this);t=parseFloat(s.find(".latitude > input").val());n=parseFloat(s.find(".longitude > input").val());!isNaN(t)&&!isNaN(n)&&r.placeMarker.apply(s,[t,n,!0,i])},placeMarker:function(t,n){var i=arguments[2],s=arguments[3],o=e(this),u=o.data("location"),a=!!u.marker.object;t=r.standardizeCoordinate.apply(o,[t]);n=r.standardizeCoordinate.apply(o,[n]);o.find(".latitude > input").val().match(/^\d+\.[0]*$/)||o.find(".latitude > input").val(t);o.find(".longitude > input").val().match(/^\d+\.[0]*$/)||o.find(".longitude > input").val(n);if(!a){u.marker.object=L.marker([t,n],{draggable:!0}).addTo(u.map.object);r.enableHelperLink.apply(o,["remove-marker"]);r.bindMarkerEvents.apply(o)}else u.marker.object.setLatLng(new L.LatLng(t,n));i&&t&&n&&r.recenterMap.apply(o,[t,n,s])},recenterMap:function(t,n){var r=new L.LatLng(parseFloat(t),parseFloat(n)),i=e(this),s=i.data("location"),o=arguments[2]||s.starting_zoom;s.map.object.panTo(r).setZoom(o)},removeMarker:function(){var t=e(this),n=t.data("location");if(!n.marker.object)return;r.disableHelperLink.apply(t,["remove-marker"]);n.map.object.removeLayer(n.marker.object);n.marker.object=null;t.find(".latitude > input, .longitude > input").val("")},bindMapEvents:function(){var t=e(this),n=t.data("location");n.map.object.on("click",function(e){n.marker.object||r.placeMarker.apply(t,[e.latlng.lat.toFixed(n.float_precision),e.latlng.lng.toFixed(n.float_precision)])})},bindMarkerEvents:function(){var t=e(this),n=t.data("location");n.marker.object.on("drag",function(e){var i=e.target._latlng.lat.toFixed(n.float_precision),s=e.target._latlng.lng.toFixed(n.float_precision);r.placeMarker.apply(t,[i,s])});n.marker.object.on("dragend",function(e){var i=e.target._latlng.lat.toFixed(n.float_precision),s=e.target._latlng.lng.toFixed(n.float_precision);r.placeMarker.apply(t,[i,s])})}};e.fn.location=function(t){if(r[t])return r[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof r=="object"||e.isFunction(t)||!t)return r.init.apply(this,arguments);e.error("Method "+t+" does not exist for jQuery.location")}})(jQuery);